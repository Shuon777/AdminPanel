{% extends "base.html" %}
{% block title %}–¢–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç (Core API Link){% endblock %}

{% block content %}
<style>
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –¥–µ–±–∞–≥-—Å–æ–æ–±—â–µ–Ω–∏—è */
    .system-message-container {
        width: 100%;
        margin: 20px 0;
        padding: 0;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞–¥ –±–ª–æ–∫–æ–º –∫–æ–¥–∞ */
    .debug-header {
        font-size: 0.8rem;
        font-weight: 700;
        color: #64748b; /* –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π */
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* –°–∞–º –±–ª–æ–∫ —Å –∫–æ–¥–æ–º */
    .debug-block {
        /* –§–æ–Ω: –æ—á–µ–Ω—å —Ç–µ–º–Ω—ã–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π (–∫–∞–∫ –≤ IDE) */
        background-color: #111827 !important; 
        /* –¢–µ–∫—Å—Ç: –º—è–≥–∫–∏–π –±–µ–ª—ã–π/—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π (–≤—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç) */
        color: #f1f5f9 !important; 
        
        padding: 20px !important;
        border-radius: 12px !important;
        border: 1px solid #374151 !important;
        
        /* –®—Ä–∏—Ñ—Ç: —É–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ 1rem (16px) –∏ –¥–æ–±–∞–≤–∏–ª–∏ —á–µ—Ç–∫–∏–µ Mono-—Å—Ç–µ–∫–∏ */
        font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace !important;
        font-size: 0.95rem !important; 
        line-height: 1.6 !important;
        
        white-space: pre-wrap !important;
        word-break: break-all !important;
        margin: 0 !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }

    /* –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è –∫–ª—é—á–µ–π –≤ JSON (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ JS –∑–∞–º–µ–Ω—É) */
    .debug-block b {
        color: #10b981; /* –ü—Ä–∏—è—Ç–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ */
        font-weight: normal;
    }

    /* –ü—É–∑—ã—Ä–∏ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –∫–∞–∑–∞–ª–∏—Å—å –º–µ–ª–∫–∏–º–∏) */
    .message-bubble {
        font-size: 1rem;
    }
</style>
<div class="card shadow-sm mb-3" style="border-radius: 16px;">
    <div class="card-body d-flex align-items-center justify-content-between py-2 px-4 bg-light" style="border-radius: 16px;">
        <div class="d-flex gap-4">
            <!-- –†–µ–∂–∏–º -->
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="setting-mode" checked>
                <label class="form-check-label fw-bold" for="setting-mode">GigaChat Mode</label>
            </div>
            <!-- Debug -->
            <div class="form-check form-switch text-danger">
                <input class="form-check-input" type="checkbox" id="setting-debug">
                <label class="form-check-label fw-bold" for="setting-debug">üêû Debug Mode</label>
            </div>
        </div>
        <div>
            <span class="text-muted small">ID: <b>{{ request.session.user_id }}</b></span>
            <a href="/logout" class="btn btn-sm btn-link text-danger ms-2">–í—ã–π—Ç–∏</a>
        </div>
    </div>
</div>

<div class="card shadow-sm" style="height: calc(100vh - 180px); display: flex; flex-direction: column; border-radius: 16px;">
    <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chat-window" style="flex: 1; overflow-y: auto; padding: 25px; background: #f8fafc;">
        <div class="message bot-message">
            <div class="message-bubble shadow-sm">
                –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –∫ <b>Core API</b>. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏–∫—É –∑–¥–µ—Å—å.
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-indicator" class="px-4 py-2 d-none">
        <span class="badge bg-light text-primary border">
            <span class="spinner-border spinner-border-sm me-2"></span> –ú–æ–∑–≥ –±–æ—Ç–∞ –¥—É–º–∞–µ—Ç...
        </span>
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div class="chat-input-area" style="padding: 20px; border-top: 1px solid #e2e8f0; background: #fff; border-radius: 0 0 16px 16px;">
        <div class="input-group">
            <input type="text" id="user-input" class="form-control border-2" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." 
                   style="border-radius: 12px 0 0 12px; padding: 14px; border-right: none;">
            <button class="btn btn-primary px-4" onclick="sendMessage()" style="border-radius: 0 12px 12px 0;">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<style>
.message { margin-bottom: 20px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.bot-message { align-items: flex-start; }
.user-message { align-items: flex-end; }

.message-bubble { 
    max-width: 80%; padding: 14px 20px; border-radius: 20px; 
    font-size: 1rem; line-height: 1.5; position: relative;
}
.bot-message .message-bubble { background: white; color: #1e293b; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }
.user-message .message-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }

.chat-img { max-width: 100%; border-radius: 12px; margin-top: 8px; cursor: zoom-in; transition: 0.2s; }
.chat-img:hover { opacity: 0.9; }

.btn-choice { 
    margin-top: 8px; margin-right: 5px; border-radius: 10px; 
    font-size: 0.9rem; font-weight: 600; padding: 8px 16px;
}
</style>

<script>
async function sendMessage(overrideText = null, isCallback = false) {
    const input = document.getElementById('user-input');
    const text = overrideText || input.value.trim();
    if (!text) return;

    // –ù–µ –≤—ã–≤–æ–¥–∏–º –≤ —á–∞—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ callback_data (—Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –¥–≤–æ–µ—Ç–æ—á–∏–µ)
    if (!isCallback || !text.includes(':')) {
        appendMessage('user', text);
    }
    
    if (!overrideText) input.value = '';
    
    const loading = document.getElementById('loading-indicator');
    loading.classList.remove('d-none');

    const chatSettings = {
        mode: document.getElementById('setting-mode').checked ? 'gigachat' : 'rasa',
        debug_mode: document.getElementById('setting-debug').checked,
        gigachat_fallback: true // –ú–æ–∂–Ω–æ —Ç–æ–∂–µ –≤—ã–Ω–µ—Å—Ç–∏ –≤ —á–µ–∫–±–æ–∫—Å
    };

    try {
        const response = await fetch('/chat/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                text: text,
                settings: chatSettings // –®–ª–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            })
        });
        
        const responses = await response.json();

        if (Array.isArray(responses)) {
            responses.forEach(resp => {
                try {
                    renderResponse(resp);
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:", err);
                }
            });
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", e);
        appendMessage('bot', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ Core API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.');
    } finally {
        loading.classList.add('d-none');
    }
}

function renderResponse(resp) {
    let msgDiv = null;
    const type = resp.type;
    const chat = document.getElementById('chat-window');

    if (type === 'debug') {
        const div = document.createElement('div');
        div.className = 'message system-message';
        
        let rawContent = resp.content;
        let displayContent = "";

        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —á–∏—Å—Ç—ã–π –ª–∏ —ç—Ç–æ JSON (–∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        try {
            const obj = JSON.parse(rawContent);
            displayContent = JSON.stringify(obj, null, 2);
        } catch (e) {
            // 2. –ï—Å–ª–∏ –Ω–µ —á–∏—Å—Ç—ã–π JSON, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ "–≥—Ä—è–∑–Ω–∞—è" —Å—Ç—Ä–æ–∫–∞ (API Request)
            // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å –µ—ë —á–∏—â–µ: —É–±–µ—Ä–µ–º Markdown-–∑–≤–µ–∑–¥–æ—á–∫–∏ –∏ –æ–±—Ä–∞—Ç–Ω—ã–µ —Ç–∏–∫–∏
            displayContent = rawContent
                .replace(/\*\*/g, '')      // –£–±–∏—Ä–∞–µ–º **
                .replace(/`/g, '')         // –£–±–∏—Ä–∞–µ–º `
                .replace(/'/g, '"')        // –ó–∞–º–µ–Ω—è–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –Ω–∞ –¥–≤–æ–π–Ω—ã–µ (–¥–ª—è –≤–∏–¥–∞)
                .replace(/None/g, 'null')  // Python -> JSON
                .replace(/True/g, 'true')
                .replace(/False/g, 'false');
        }

        div.innerHTML = `
            <div class="debug-header"><i class="bi bi-terminal-fill"></i> System Debug Log</div>
            <pre class="debug-block">${displayContent}</pre>
        `;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return div;
    }
    else if (type === 'text' || type === 'clarification') {
        msgDiv = appendMessage('bot', resp.content);
    } 
    else if (type === 'image' || type === 'photo') {
        msgDiv = appendImage('bot', resp.content);
    } 
    else if (type === 'map') {
        // –£–±–∏—Ä–∞–µ–º —Ä—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –ø—Ä–∏–¥–µ—Ç –≤ –æ–±—ä–µ–∫—Ç–µ –∫–Ω–æ–ø–æ–∫
        let mapHtml = `üìç <b>–ö–∞—Ä—Ç–∞:</b> ${resp.content || ''}<br>`;
        if (resp.static_map) mapHtml += `<img src="${resp.static_map}" class="chat-img shadow-sm mb-2">`;
        msgDiv = appendMessage('bot', mapHtml);
    }

    // --- –£–õ–£–ß–®–ï–ù–ù–´–ô –ë–õ–û–ö –ö–ù–û–ü–û–ö ---
    const buttons = resp.buttons || (resp.reply_markup ? resp.reply_markup.inline_keyboard : null);
    
    if (buttons && buttons.length > 0 && msgDiv) {
        const btnContainer = document.createElement('div');
        btnContainer.className = 'mt-3 d-flex flex-wrap gap-2';
        
        buttons.flat().forEach(btn => {
            // –ï—Å–ª–∏ —É –∫–Ω–æ–ø–∫–∏ –µ—Å—Ç—å URL ‚Äî —ç—Ç–æ —Å—Å—ã–ª–∫–∞
            if (btn.url) {
                const link = document.createElement('a');
                link.href = btn.url;
                link.target = "_blank"; // –û—Ç–∫—Ä—ã–≤–∞—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                link.className = 'btn btn-sm btn-success shadow-sm px-3 py-2'; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å—Å—ã–ª–æ–∫
                link.style.borderRadius = '10px';
                link.style.textDecoration = 'none';
                link.innerHTML = `<i class="bi bi-geo-alt-fill me-1"></i> ${btn.text}`;
                btnContainer.appendChild(link);
            } 
            // –ò–Ω–∞—á–µ ‚Äî —ç—Ç–æ –æ–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (—É—Ç–æ—á–Ω–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞)
            else {
                const b = document.createElement('button');
                b.className = 'btn btn-sm btn-outline-primary shadow-sm px-3 py-2';
                b.style.borderRadius = '10px';
                b.innerText = btn.text;
                b.onclick = () => {
                    btnContainer.remove(); 
                    sendMessage(btn.callback_data || btn.text, true);
                };
                btnContainer.appendChild(b);
            }
        });
        
        msgDiv.querySelector('.message-bubble').appendChild(btnContainer);
    }
}

function appendMessage(sender, text) {
    const chat = document.getElementById('chat-window');
    const div = document.createElement('div');
    div.className = `message ${sender}-message`;
    div.innerHTML = `<div class="message-bubble shadow-sm">${text}</div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div; // –í–∞–∂–Ω–æ!
}

function appendImage(sender, url) {
    const chat = document.getElementById('chat-window');
    const div = document.createElement('div');
    div.className = `message ${sender}-message`;
    div.innerHTML = `<div class="message-bubble shadow-sm"><img src="${url}" class="chat-img" onerror="this.src='https://placehold.co/400x300?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏+—Ñ–æ—Ç–æ'"></div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div; // –í–∞–∂–Ω–æ!
}

document.getElementById('user-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
{% endblock %}